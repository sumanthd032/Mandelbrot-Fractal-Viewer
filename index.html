<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandelbrot Fractal Viewer</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f0f0f0; }
        canvas { border: 2px solid #333; display: block; margin: 20px auto; }
        .controls { margin: 20px; }
        label { margin: 0 10px; }
    </style>
</head>
<body>
    <h1>Mandelbrot Fractal Viewer</h1>
    <canvas id="mandelbrot-canvas" width="400" height="400"></canvas>
    <div class="controls">
        <label>Resolution: <input type="range" id="resolution" min="100" max="800" value="400" step="50"></label>
        <label>Max Iterations: <input type="range" id="max-iter" min="10" max="500" value="100" step="10"></label>
        <label>Zoom: <input type="range" id="zoom" min="0.1" max="10" value="1" step="0.1"></label>
        <label>Pan X: <input type="range" id="pan-x" min="-2" max="1" value="0" step="0.01"></label>
        <label>Pan Y: <input type="range" id="pan-y" min="-1.5" max="1.5" value="0" step="0.01"></label>
    </div>

    <py-script>
        import numpy as np
        from js import document
        import matplotlib.pyplot as plt
        from matplotlib import cm
        from pyodide.ffi import create_proxy

        def mandelbrot(h, w, max_iter, x_min=-2, x_max=1, y_min=-1.5, y_max=1.5):
            x = np.linspace(x_min, x_max, w)
            y = np.linspace(y_min, y_max, h)
            c = x[np.newaxis, :] + 1j * y[:, np.newaxis]
            z = np.zeros_like(c, dtype=np.complex128)
            output = np.zeros(c.shape, dtype=np.int32)

            for i in range(max_iter):
                mask = np.abs(z) <= 2
                z[mask] = z[mask] * z[mask] + c[mask]
                output[mask] += 1
                output[~mask] = max_iter

            return output

        def draw_mandelbrot(*args, **kwargs):
            resolution = int(document.getElementById('resolution').value)
            max_iter = int(document.getElementById('max-iter').value)
            zoom = float(document.getElementById('zoom').value)
            pan_x = float(document.getElementById('pan-x').value)
            pan_y = float(document.getElementById('pan-y').value)

            # Adjust bounds for zoom and pan
            x_min = -2 / zoom + pan_x
            x_max = 1 / zoom + pan_x
            y_min = -1.5 / zoom + pan_y
            y_max = 1.5 / zoom + pan_y

            # Generate Mandelbrot set
            mandel = mandelbrot(resolution, resolution, max_iter, x_min, x_max, y_min, y_max)
            
            # Create a plot
            fig, ax = plt.subplots(figsize=(6, 6))
            ax.imshow(mandel, cmap='inferno', extent=[x_min, x_max, y_min, y_max])
            ax.axis('off')
            
            # Display on canvas
            canvas = document.getElementById('mandelbrot-canvas')
            plt.canvas.draw()
            canvas_data = plt.canvas.tostring_rgb()
            canvas.width = resolution
            canvas.height = resolution
            ctx = canvas.getContext('2d')
            img = document.createElement('img')
            img.src = f'data:image/png;base64,{canvas_data}'
            img.onload = lambda: ctx.drawImage(img, 0, 0, resolution, resolution)
            plt.close(fig)

        # Set up event listeners for sliders
        sliders = ['resolution', 'max-iter', 'zoom', 'pan-x', 'pan-y']
        for slider_id in sliders:
            slider = document.getElementById(slider_id)
            slider.addEventListener('input', create_proxy(draw_mandelbrot))

        # Initial render
        draw_mandelbrot()
    </py-script>
</body>
</html>